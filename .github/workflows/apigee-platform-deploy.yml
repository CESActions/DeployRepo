name: Apigee Deploy (Platform) — from GitHub Release

on:
  repository_dispatch:
    types: [ "apigee_release" ]
  workflow_dispatch:
    inputs:
      source_repo:
        description: "owner/name of Repo A (e.g., your-org/your-api-repo)"
        required: false
      tag:
        description: "Release tag to deploy (e.g., v1.2.3)"
        required: false
      rollback_revision:
        description: "PROD only: if set, activate this revision instead of new deploy"
        required: false
        default: ""

permissions:
  id-token: write
  contents: read

env:
  PROXY_NAME: helloworldjava
  ARTIFACT_NAME: helloworldjava.zip   # must match the release asset name from Repo A
  HEALTH_PATH: /helloworldjava
  SMOKE_MAX_LATENCY_MS: "1500"

jobs:
  resolve_input:
    runs-on: ubuntu-latest
    outputs:
      SRC_REPO: ${{ steps.out.outputs.SRC_REPO }}
      TAG: ${{ steps.out.outputs.TAG }}
    steps:
      - id: out
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SRC="${{ github.event.client_payload.source_repo }}"
            TAG="${{ github.event.client_payload.tag }}"
          else
            SRC="${{ github.event.inputs.source_repo }}"
            TAG="${{ github.event.inputs.tag }}"
          fi
          echo "SRC_REPO=${SRC}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "Resolved source_repo=${SRC}, tag=${TAG}"

  fetch_artifact:
    needs: resolve_input
    runs-on: ubuntu-latest
    steps:
      - name: Download release asset from Repo A
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ needs.resolve_input.outputs.SRC_REPO }}
          tag: ${{ needs.resolve_input.outputs.TAG }}
          fileName: ${{ env.ARTIFACT_NAME }}
          token: ${{ secrets.SOURCE_REPO_TOKEN }}

      - name: Upload artifact for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: apiproxy-bundle
          path: ${{ env.ARTIFACT_NAME }}

  # ---------- DEV ----------
  deploy_dev:
    name: DEV — Deploy + Verify + Smoke
    needs: fetch_artifact
    runs-on: ubuntu-latest
    environment: dev
    env:
      APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
      APIGEE_ENV: ${{ secrets.APIGEE_ENV }}           # dev
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      APIGEE_BASE_URL: ${{ secrets.APIGEE_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: apiproxy-bundle, path: . }

      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "17" }

      - name: Authenticate to Google (OIDC)
        id: gauth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token

      - name: Export access token
        run: echo "APIGEE_ACCESS_TOKEN=${{ steps.gauth.outputs.access_token }}" >> $GITHUB_ENV

      # --- Config as code: KVMs, TargetServers, Products, Developers, Apps
      - name: Apply DEV config (config plugin 2.x)
        run: |
          mvn -Pdev -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            initialize \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apps \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apiproducts \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:developers \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:kvms \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:targetservers

      - name: Deploy proxy to DEV (deploy plugin 2.x)
        run: |
          mvn -Pdev -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DAPIGEE_ENV="${APIGEE_ENV}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            deploy

      # Inline Python: Mgmt API verify READY + runtime smoke
      - name: Verify READY (Mgmt API) + Smoke (Runtime)
        env:
          BASE_URL: ${{ env.APIGEE_BASE_URL }}
          API_KEY:  ${{ secrets.CONSUMER_API_KEY }}
        run: |
          cat > verify.py <<'PY'
          import json, sys, time, urllib.request, urllib.error, os
          ORG=os.environ["APIGEE_ORG"]; ENV=os.environ["APIGEE_ENV"]; API=os.environ["PROXY_NAME"]; TOK=os.environ["APIGEE_ACCESS_TOKEN"]
          URL=f"https://apigee.googleapis.com/v1/organizations/{ORG}/environments/{ENV}/apis/{API}/deployments"
          deadline=time.time()+180; last=None
          def get(u,t):
              r=urllib.request.Request(u); r.add_header("Authorization",f"Bearer {t}"); r.add_header("Accept","application/json")
              with urllib.request.urlopen(r,timeout=30) as resp: return json.loads(resp.read().decode("utf-8"))
          while time.time()<deadline:
              try:
                  js=get(URL,TOK); last=[(d.get("revision"),(d.get("state") or "").upper()) for d in js.get("deployments",[])]
                  if any(s=="READY" for _,s in last): print(f"[verify] READY {last}"); break
                  print(f"[verify] Waiting... {last}"); time.sleep(5)
              except urllib.error.HTTPError as e: print(f"[verify] HTTP {e.code}",file=sys.stderr); time.sleep(5)
              except Exception as e: print(f"[verify] {e}",file=sys.stderr); time.sleep(5)
          else:
              print(f"[verify] Timeout. Last: {last}",file=sys.stderr); sys.exit(2)
          PY
          cat > smoke.py <<'PY'
          import json,sys,time,urllib.parse,urllib.request,os
          base=os.environ["APIGEE_BASE_URL"]; path=os.environ.get("HEALTH_PATH","/"); key=os.environ.get("API_KEY")
          maxlat=int(os.environ.get("SMOKE_MAX_LATENCY_MS","1500"))
          u=urllib.parse.urljoin(base.rstrip('/')+'/', path.lstrip('/'))
          if key: u+=("&" if "?" in u else "?")+"apikey="+urllib.parse.quote(key)
          t=time.time()
          try:
              r=urllib.request.Request(u,headers={"Accept":"application/json"})
              with urllib.request.urlopen(r,timeout=20) as resp:
                  body,code=resp.read(),resp.getcode()
          except Exception as e: print(f"[smoke] ERROR {e}",file=sys.stderr); sys.exit(2)
          lat=int((time.time()-t)*1000); print(f"[smoke] {code} {lat}ms\n{body[:200]}")
          if code!=200: sys.exit(3)
          if lat>maxlat: sys.exit(4)
          print("[smoke] OK")
          PY
          python3 verify.py
          HEALTH_PATH="${HEALTH_PATH}" python3 smoke.py

  # ---------- TEST (approval gate) ----------
  deploy_test:
    name: TEST — Deploy + Verify + Smoke (requires approval)
    needs: deploy_dev
    runs-on: ubuntu-latest
    environment: test       # add Required reviewers in repo Settings → Environments
    env:
      APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
      APIGEE_ENV: ${{ secrets.APIGEE_ENV }}      # set to "test-env" in this Environment’s secrets
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      APIGEE_BASE_URL: ${{ secrets.APIGEE_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: apiproxy-bundle, path: . }
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "17" }
      - name: Authenticate to Google (OIDC)
        id: gauth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token
      - name: Export access token
        run: echo "APIGEE_ACCESS_TOKEN=${{ steps.gauth.outputs.access_token }}" >> $GITHUB_ENV

      - name: Apply TEST config
        run: |
          mvn -Ptest -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            initialize \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apps \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apiproducts \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:developers \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:kvms \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:targetservers

      - name: Deploy proxy to TEST
        run: |
          mvn -Ptest -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DAPIGEE_ENV="${APIGEE_ENV}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            deploy

      - name: Verify READY + Smoke
        env:
          APIGEE_BASE_URL: ${{ env.APIGEE_BASE_URL }}
          API_KEY:  ${{ secrets.CONSUMER_API_KEY }}
        run: |
          python3 verify.py
          HEALTH_PATH="${HEALTH_PATH}" python3 smoke.py

  # ---------- PROD (approval + optional rollback) ----------
  deploy_prod:
    name: PROD — Deploy + Verify + Smoke (approval & rollback)
    needs: deploy_test
    runs-on: ubuntu-latest
    environment: prod
    env:
      APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
      APIGEE_ENV: ${{ secrets.APIGEE_ENV }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      APIGEE_BASE_URL: ${{ secrets.APIGEE_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: apiproxy-bundle, path: . }
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "17" }
      - name: Authenticate to Google (OIDC)
        id: gauth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token
      - name: Export access token
        run: echo "APIGEE_ACCESS_TOKEN=${{ steps.gauth.outputs.access_token }}" >> $GITHUB_ENV

      - name: Roll back to specific revision (if provided)
        if: ${{ inputs.rollback_revision != '' }}
        run: |
          mvn -Pprod -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DAPIGEE_ENV="${APIGEE_ENV}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            -Dapigee.revision="${{ inputs.rollback_revision }}" \
            com.apigee.edge.config:apigee-deploy-maven-plugin:2.7.0:activate

      - name: Apply PROD config
        if: ${{ inputs.rollback_revision == '' }}
        run: |
          mvn -Pprod -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            initialize \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apps \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:apiproducts \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:developers \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:kvms \
            com.apigee.edge.config:apigee-config-maven-plugin:2.9.3:targetservers

      - name: Deploy proxy to PROD
        if: ${{ inputs.rollback_revision == '' }}
        run: |
          mvn -Pprod -B -DskipTests \
            -DAPIGEE_ORG="${APIGEE_ORG}" \
            -DAPIGEE_ENV="${APIGEE_ENV}" \
            -DGCP_PROJECT_ID="${GCP_PROJECT_ID}" \
            -DAPIGEE_ACCESS_TOKEN="${APIGEE_ACCESS_TOKEN}" \
            deploy

      - name: Verify READY + Smoke
        env:
          APIGEE_BASE_URL: ${{ env.APIGEE_BASE_URL }}
          API_KEY:  ${{ secrets.CONSUMER_API_KEY }}
        run: |
          python3 verify.py
          HEALTH_PATH="${HEALTH_PATH}" python3 smoke.py
